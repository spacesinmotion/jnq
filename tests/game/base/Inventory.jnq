
use Item, ItemItem from Item
use Image from tests.game.gfx.Image 
use OverlayText from tests.game.gfx.OverlayText

cfn strcmp(a *char, b *char) int

type Inventory struct {
  items vec[]Item
  tools vec[]Item
}

fn NewInventory() Inventory {
  return Inventory{}
}

fn destroy(inv *Inventory) {
  for (i := 0; i< inv.items.len; ++i ) {
    m := &inv.items[i]
    m.text.destroy()
    if (m.img)
      m.img.destroy() 
  }
  for (i := 0; i< inv.tools.len; ++i ) {
    m := &inv.tools[i]
    m.text.destroy()
    if (m.img)
      m.img.destroy() 
  }
  inv.items.free()
  inv.tools.free()
}

fn find_item(l *vec[]Item, name *char) *Item {
  for (i := 0; i < l.len; ++i ) 
    if (strcmp(l[i].item.name, name) == 0)
      return &l[i]
  return null
}

fn init_item(it *Item, img *Image, pos int, row int) {
  it.fx = it.x = 200.0f + pos as float * 64.0f 
  it.fy = it.y = 10.0f
  it.row = row
  //s.text = gfx.new_overlay_text();
  //s.text:set_color(0.9, 0.9, 0.9)
  //s.img = gfx.new_overlay_billboard();
  //s.img:set_size(16, 16)
  //s.img:set_color(1, 1, 1)
  //s.img:set_texture(img)
}

fn add_to(l *vec[]Item, n *char, img *Image, row int) *Item{
  it := find_item(l, n);
  if (!it) {
    nitem := Item{}
    init_item(&nitem, img, 0, row)
    l.push(nitem)
    it := &l[l.len-1];
  } 
  return it
}

fn add_item(inv *Inventory, item *ItemItem) *Item {
  s := add_to(&inv.items, item.name, item.img, 0)
  s.count++
  // s.text:set_text('x' .. tostring(s.count))
  // fn s:add_count(c) {
  //   s.count = s.count + c
  //   s.text:set_text('x' .. tostring(s.count))
  // }
  return s
}

fn add_tool(inv *Inventory, key *char, img *Image) {
  s := add_to(&inv.tools, key, img, 1)
  s.percent = 100.0f
  // s.text:set_text(tostring(s.percent) .. '%')
  // fn s:add_percent(c) {
  //   s.percent = s.percent + c
  //   s.text:set_text(tostring(s.percent) .. '%')
  // }
}

fn count_thing(inv *Inventory, item *ItemItem) int {
  it := find_item(&inv.items, item.name)
  if (it)
    return it.count
  it = find_item(&inv.tools, item.name);
  if (it != null && it.percent > 0.0f) 
    return 1

  return 0
}

fn remove(inv *Inventory, depends *Item, count int) {
  for (i:=0; i<count; ++i) {
    d := &depends[i]
    n := d.item.name
    it := find_item(&inv.items, n);
    if (it)
      it.add_count(-d.count) 
    it = find_item(&inv.tools, n);
    if (it)
      it.add_percent(-d.item.usage) 
  }
}

fn update(inv *Inventory, dt float) {
  for (i := 0; i< inv.items.len; ++i ) 
    inv.items[i].update(i);
  for (i := 0; i< inv.tools.len; ++i ) 
    inv.tools[i].update(i);
}

